"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[9371],{3905:function(t,e,n){n.d(e,{Zo:function(){return d},kt:function(){return h}});var a=n(7294);function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){if(null==t)return{};var n,a,o=function(t,e){if(null==t)return{};var n,a,o={},r=Object.keys(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var l=a.createContext({}),p=function(t){var e=a.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},d=function(t){var e=p(t.components);return a.createElement(l.Provider,{value:e},t.children)},u={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},c=a.forwardRef((function(t,e){var n=t.components,o=t.mdxType,r=t.originalType,l=t.parentName,d=s(t,["components","mdxType","originalType","parentName"]),c=p(n),h=o,f=c["".concat(l,".").concat(h)]||c[h]||u[h]||r;return n?a.createElement(f,i(i({ref:e},d),{},{components:n})):a.createElement(f,i({ref:e},d))}));function h(t,e){var n=arguments,o=e&&e.mdxType;if("string"==typeof t||o){var r=n.length,i=new Array(r);i[0]=c;var s={};for(var l in e)hasOwnProperty.call(e,l)&&(s[l]=e[l]);s.originalType=t,s.mdxType="string"==typeof t?t:o,i[1]=s;for(var p=2;p<r;p++)i[p]=n[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},5297:function(t,e,n){n.r(e),n.d(e,{assets:function(){return d},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return u}});var a=n(3117),o=n(102),r=(n(7294),n(3905)),i=["components"],s={title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",layout:"playbook_js",tags:["playbook"]},l=void 0,p={unversionedId:"docs/liberator-ingestion",id:"docs/liberator-ingestion",title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",source:"@site/docs/docs/liberator-ingestion.md",sourceDirName:"docs",slug:"/docs/liberator-ingestion",permalink:"/Data-Platform-Playbook/docs/liberator-ingestion",draft:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/docs/liberator-ingestion.md",tags:[{label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",frontMatter:{title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Import spreadsheets from G Drive",permalink:"/Data-Platform-Playbook/docs/import-spreadsheet-from-g-drive"},next:{title:"Production to pre-production data sync",permalink:"/Data-Platform-Playbook/docs/production-to-pre-production-sync"}},d={},u=[{value:"1. SQL dump is uploaded into the platform",id:"1-sql-dump-is-uploaded-into-the-platform",level:4},{value:"2. RDS snapshot is created from the SQL dump",id:"2-rds-snapshot-is-created-from-the-sql-dump",level:4},{value:"3. Getting the data from the RDS snapshot into the landing zone as parquet files",id:"3-getting-the-data-from-the-rds-snapshot-into-the-landing-zone-as-parquet-files",level:4}],c={toc:u};function h(t){var e=t.components,n=(0,o.Z)(t,i);return(0,r.kt)("wrapper",(0,a.Z)({},c,n,{components:e,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This section describes how the Liberator dataset gets ingested into the data platform. "),(0,r.kt)("h4",{id:"1-sql-dump-is-uploaded-into-the-platform"},"1. SQL dump is uploaded into the platform"),(0,r.kt)("p",null,"The company who owns the dataset (Farthest Gate) uploads a zipped SQL dump of the whole database to S3 bucket in the data platform production AWS account at the path ",(0,r.kt)("inlineCode",{parentName:"p"},"s3://dataplatform-stg-liberator-data-storage/parking/"),".\nThe file needs to be named ",(0,r.kt)("inlineCode",{parentName:"p"},"liberator_dump_210604.zip")," where the date stamp at the end is the current date."),(0,r.kt)("h4",{id:"2-rds-snapshot-is-created-from-the-sql-dump"},"2. RDS snapshot is created from the SQL dump"),(0,r.kt)("p",null,"The upload of the S3 file triggers a cloudwatch event that in turn triggers the following two things."),(0,r.kt)("p",null,"First, it starts a lambda (",(0,r.kt)("inlineCode",{parentName:"p"},"*liberator-prod-to-pre-prod"),") which copies the zip file to pre-production then the remaining steps run in both accounts.\nThis is a temporary process, when we have finished our move to production we will only copy down raw & refined zone liberator data with the rest of the data in the platform. "),(0,r.kt)("p",null,"Secondly, it triggers the start of an ECS task (",(0,r.kt)("inlineCode",{parentName:"p"},"*liberator-to-rds-snapshot"),").\nThe task does the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Deletes any RDS snapshots that already exist"),(0,r.kt)("li",{parentName:"ul"},"Unzips the file"),(0,r.kt)("li",{parentName:"ul"},"Creates a new database from the SQL dump"),(0,r.kt)("li",{parentName:"ul"},"Starts off the process to create a database snapshot from this database")),(0,r.kt)("h4",{id:"3-getting-the-data-from-the-rds-snapshot-into-the-landing-zone-as-parquet-files"},"3. Getting the data from the RDS snapshot into the landing zone as parquet files"),(0,r.kt)("p",null,"An event is published to an SNS topic (",(0,r.kt)("inlineCode",{parentName:"p"},"*-rds-snapshot-to-s3"),") on the creation of the snapshot.\nAn SQS queue (",(0,r.kt)("inlineCode",{parentName:"p"},"*-rds-snapshot-to-s3"),") subscribes to this topic and a lambda function (",(0,r.kt)("inlineCode",{parentName:"p"},"-*rds-snapshot-to-s3"),") reads from that SQS queue."),(0,r.kt)("p",null,"The lambda function first finds the latest snapshot.\nIf it is still creating then it puts a message back into the queue with a 15 minute delay.\nIf it has finished creating, it starts an RDS export task that writes the snapshot to S3 (",(0,r.kt)("inlineCode",{parentName:"p"},"s3://rds-export-storage"),") in parquet format."),(0,r.kt)("p",null,"It then puts a message into another queue (",(0,r.kt)("inlineCode",{parentName:"p"},"*-s3-to-s3-copier"),") with a 15 minute delay."),(0,r.kt)("p",null,"Another lambda function (",(0,r.kt)("inlineCode",{parentName:"p"},"*-s3-to-s3-copier"),") reads from the copier queue.\nThis lambda first checks if the export task has finished.\nIf not it puts another message back into the queue with a 15 minute delay.\nIf it has finished, it will copy all the files into the landing zone, with the standard date partitions added to the objects keys and any extra partitions added by the RDS export task are removed."),(0,r.kt)("p",null,"The lambda function will then start the glue parking libertor workflow (",(0,r.kt)("inlineCode",{parentName:"p"},"*parking-liberator-data-workflow"),"), which copies the data into the raw zone and runs a number of transformation jobs scheduled into the workflow."))}h.isMDXComponent=!0}}]);