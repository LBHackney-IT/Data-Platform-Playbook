"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[5398],{6498:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var n=i(4848),s=i(8453);const a={id:"data-quality-testing-guide",title:"Guide to testing data quality in Glue Jobs",description:"A guide to continuous data quality testing in Glue Jobs",layout:"playbook_js",tags:["playbook"]},o=void 0,r={id:"playbook/transforming-data/guides-to-testing-in-the-platform/data-quality-testing-guide",title:"Guide to testing data quality in Glue Jobs",description:"A guide to continuous data quality testing in Glue Jobs",source:"@site/docs/playbook/transforming-data/guides-to-testing-in-the-platform/003-data-quality-testing-guide.md",sourceDirName:"playbook/transforming-data/guides-to-testing-in-the-platform",slug:"/playbook/transforming-data/guides-to-testing-in-the-platform/data-quality-testing-guide",permalink:"/Data-Platform-Playbook/playbook/transforming-data/guides-to-testing-in-the-platform/data-quality-testing-guide",draft:!1,unlisted:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/playbook/transforming-data/guides-to-testing-in-the-platform/003-data-quality-testing-guide.md",tags:[{inline:!0,label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",sidebarPosition:3,frontMatter:{id:"data-quality-testing-guide",title:"Guide to testing data quality in Glue Jobs",description:"A guide to continuous data quality testing in Glue Jobs",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"How to create a Lambda function for data ingestion on the Data Analytics Platform",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/creating-a-lambda-function-step-by-step"},next:{title:"Guide to unit testing on the Data Platform",permalink:"/Data-Platform-Playbook/playbook/transforming-data/guides-to-testing-in-the-platform/unit-testing-guide"}},l={},c=[{value:"Resources",id:"resources",level:2},{value:"Context",id:"context",level:2},{value:"Pre-requisites of data quality testing",id:"pre-requisites-of-data-quality-testing",level:2},{value:"Pre-requisites to using PyDeequ",id:"pre-requisites-to-using-pydeequ",level:2},{value:"Types of Data Quality tests",id:"types-of-data-quality-tests",level:2},{value:"1. Fact-checking of data values example",id:"1-fact-checking-of-data-values-example",level:3},{value:"2. Historical analysis of the dataset - Example Anomaly Detection",id:"2-historical-analysis-of-the-dataset---example-anomaly-detection",level:3},{value:"Providing tags to metrics for verification constraint checks",id:"providing-tags-to-metrics-for-verification-constraint-checks",level:2},{value:"Stopping Glue jobs when constraint checks fail",id:"stopping-glue-jobs-when-constraint-checks-fail",level:2},{value:"Commit your data quality tests to your Glue job",id:"commit-your-data-quality-tests-to-your-glue-job",level:2},{value:"Email notifications of failing Glue jobs",id:"email-notifications-of-failing-glue-jobs",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"resources",children:"Resources"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://github.com/awslabs/python-deequ",children:"PyDeequ README"})}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"context",children:"Context"}),"\n",(0,n.jsx)(t.p,{children:"Data Quality tests are used to verify the quality of production datasets.\nThey are intended to make assertions against the data itself as opposed to the code when unit testing."}),"\n",(0,n.jsx)(t.p,{children:"This guide introduces the Python library 'PyDeequ' which can be used to perform data quality testing in your Glue scripts.\nPyDeequ allows you to calculate data quality metrics on your dataset, define and verify data quality constraints,\nand be informed about changes in the data distribution."}),"\n",(0,n.jsx)(t.h2,{id:"pre-requisites-of-data-quality-testing",children:"Pre-requisites of data quality testing"}),"\n",(0,n.jsx)(t.p,{children:"In order to efficiently test your data, it is necessary that you define and set the right expectations from the ETL process and the data itself.\nIt is therefore helpful to have a good understanding of the purpose of the data and think about the following questions:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsx)(t.p,{children:"What do you want to achieve with your data?"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Knowing what the intended purpose of the data is and what specific business questions it will help answer."}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsx)(t.p,{children:"What does high-quality data mean to you?"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"You must understand the metrics that will help you to measure data quality."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.h2,{id:"pre-requisites-to-using-pydeequ",children:"Pre-requisites to using PyDeequ"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Update the job arguments of your Glue job to include:"}),"\n"]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsx)(t.p,{children:"Metrics repository S3 target location using the template format:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:'"--deequ_metrics_location" = "s3://${module.<ZONE>_zone.bucket_id}/quality-metrics/department=<YOUR-DEPARTMENT-NAME>/dataset=<DATASET-NAME>/deequ-metrics.json"\n'})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsxs)(t.em,{children:[(0,n.jsx)(t.code,{children:"<ZONE>"})," refers to either: ",(0,n.jsx)(t.code,{children:"raw"}),", ",(0,n.jsx)(t.code,{children:"landing"}),", ",(0,n.jsx)(t.code,{children:"refined"}),", or ",(0,n.jsx)(t.code,{children:"trusted"})," S3 zones."]})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsxs)(t.em,{children:[(0,n.jsx)(t.code,{children:"<YOUR-DEPARTMENT-NAME>"})," and ",(0,n.jsx)(t.code,{children:"<DATASET-NAME>"})," must be all lowercase with words separated by hyphens."]})}),"\n",(0,n.jsx)(t.p,{children:"For example:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:'"--deequ_metrics_location" = "s3://${module.refined_zone.bucket_id}/quality-metrics/department=housing-repairs/dataset=repairs-axis/deequ-metrics.json"\n'})}),"\n",(0,n.jsx)(t.p,{children:"The metrics stored here can help you understand the profile of your data as well as help you come up with suitable constraints to measure the data quality of your dataset."}),"\n"]}),"\n"]}),"\n",(0,n.jsxs)(t.ol,{start:"2",children:["\n",(0,n.jsx)(t.li,{children:"Import the following functions from PyDeequ in the top of your script.\nAs you are writing your tests, you may discover that you need additional functions from the PyDeequ library.\nYou may import these as required. The examples in this guide also introduce some functions that may be used."}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"from pydeequ.repository import FileSystemMetricsRepository, ResultKey\nfrom pydeequ.verification import VerificationSuite, VerificationResult\nfrom helpers.data_quality_testing import get_metrics_target_location, cancel_job_if_failing_quality_checks\n"})}),"\n",(0,n.jsxs)(t.ol,{start:"3",children:["\n",(0,n.jsx)(t.li,{children:"Add the metrics target location and also a metrics repoistory and result key instance. This will ensure that data quality metrics are written to the deequ-metrics.json file in S3."}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"metrics_target_location = get_metrics_target_location()\n\nmetricsRepository = FileSystemMetricsRepository(spark_session, metrics_target_location)\nresultKey = ResultKey(spark_session, ResultKey.current_milli_time(), {})\n"})}),"\n",(0,n.jsxs)(t.admonition,{type:"caution",children:[(0,n.jsxs)(t.p,{children:["There is a ",(0,n.jsx)(t.a,{href:"https://github.com/awslabs/python-deequ/issues/7",children:"defect with PyDeequ"}),' which causes the Glue Spark session to hang.\nWhile this issue still exists, we recommend wrapping your data quality verification code in a "try/finally" block (see example ',(0,n.jsx)(t.a,{href:"https://github.com/LBHackney-IT/Data-Platform/blob/6468778d865c6203d1d11df78805720da9cd22b5/scripts/elec_mech_fire_tv_aerials_cleaning.py#L79-L105",children:"here"}),")."]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"try:\n  ...\nfinally:\n    spark_session.sparkContext._gateway.close()\n    spark_session.stop()\n"})})]}),"\n",(0,n.jsx)(t.h2,{id:"types-of-data-quality-tests",children:"Types of Data Quality tests"}),"\n",(0,n.jsxs)(t.p,{children:["We introduce two types of data quality tests; ",(0,n.jsx)(t.strong,{children:"fact-checking of data values"})," and ",(0,n.jsx)(t.strong,{children:"historical analysis of the dataset"})," being processed."]}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:"Fact-checking of data values"}),": involves validating the values of columns and checking that they conform to set standards.\nFor example, an ID column only contains unique values or values in a given column should be in a specific range, between a minimum and maximum value."]}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.strong,{children:"Historical analysis of the dataset"}),": involves analysing a dataset as it evolves over time and testing that the new data is consistent with a baseline.\nThis requires having a profile or baseline of the data to compare to."]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"Below are examples of these two types of data quality tests."}),"\n",(0,n.jsx)(t.h3,{id:"1-fact-checking-of-data-values-example",children:"1. Fact-checking of data values example"}),"\n",(0,n.jsxs)(t.p,{children:["Here is an example of using Deequ checks to validate a dataframe, and storing related metrics to S3.\nThe ",(0,n.jsx)(t.code,{children:"description_of_work"})," column is checked to be complete, and ",(0,n.jsx)(t.code,{children:"work_priority_priority_code"})," between\n1 and 4 inclusively.\nThere is also the option to include a hint message on each of the checks which will be\ndisplayed to the user in the event there is a failing constraint to help diagnose the problem.\nFor example, the ",(0,n.jsx)(t.code,{children:"hasMin"})," check has the hint message:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{children:"'The minimum(work_priority_priority_code) >= 1'\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'from pydeequ.checks import Check, CheckLevel\nfrom pydeequ.repository import FileSystemMetricsRepository, ResultKey\nfrom pydeequ.verification import VerificationSuite, VerificationResult, RelativeRateOfChangeStrategy\nfrom helpers.data_quality_testing import get_metrics_target_location\n\nmetrics_target_location = get_metrics_target_location()\n\nmetricsRepository = FileSystemMetricsRepository(spark_session, metrics_target_location)\nresultKey = ResultKey(spark_session, ResultKey.current_milli_time(), {})\n\ncheckResult = VerificationSuite(spark_session) \\\n    .onData(df) \\\n    .useRepository(metricsRepository) \\\n    .addCheck(Check(spark_session, CheckLevel.Error, "data quality checks") \\\n        .hasMin("work_priority_priority_code", lambda x: x >= 1, \'The minimum(work_priority_priority_code) >= 1\') \\\n        .hasMax("work_priority_priority_code", lambda x: x <= 4, \'The maximum(work_priority_priority_code) <= 4\')  \\\n        .isComplete("description_of_work")) \\\n    .saveOrAppendResult(resultKey) \\\n    .run()\n\ncheckResult_df = VerificationResult.checkResultsAsDataFrame(spark_session, checkResult)\ncheckResult_df.show()\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Here is a ",(0,n.jsx)(t.a,{href:"https://pydeequ.readthedocs.io/en/latest/pydeequ.html#module-pydeequ.checks",children:"list of checks"})," that are available to use."]}),"\n",(0,n.jsx)(t.admonition,{type:"caution",children:(0,n.jsx)(t.p,{children:"Remember to ensure that any checks, analyzers, anomaly checks are included within the imports."})}),"\n",(0,n.jsx)(t.h3,{id:"2-historical-analysis-of-the-dataset---example-anomaly-detection",children:"2. Historical analysis of the dataset - Example Anomaly Detection"}),"\n",(0,n.jsx)(t.p,{children:"Anomaly detection uses historic metrics to determine if a value is invalid."}),"\n",(0,n.jsxs)(t.admonition,{type:"caution",children:[(0,n.jsx)(t.p,{children:"You can only run an anomaly check if there are historic metrics results in the metrics repository you are using.\nIf no historic metrics results exist, you will get the below error message:"}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-markdown",children:"Can't execute the assertion: requirement failed:\nThere have to be previous results in the MetricsRepository!!\n"})}),(0,n.jsxs)(t.p,{children:["To avoid this error, run the standard verification constraint checks first (see ",(0,n.jsx)(t.a,{href:"#1-fact-checking-of-data-values-example",children:"Fact-checking of data values example"})," section above) and then add your anomaly constraint checks afterwards."]})]}),"\n",(0,n.jsx)(t.p,{children:"For example, we check if the size of a dataframe has increased by more than twice the previous size."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'from pydeequ.verification import VerificationSuite, VerificationResult\nfrom pydeequ.repository import FileSystemMetricsRepository, ResultKey\nfrom pydeequ.anomaly_detection import RelativeRateOfChangeStrategy\nfrom helpers.data_quality_testing import get_metrics_target_location, cancel_job_if_failing_quality_checks\n\nmetrics_target_location = get_metrics_target_location()\n\nmetricsRepository = FileSystemMetricsRepository(spark_session, metrics_target_location)\nresultKey = ResultKey(spark_session, ResultKey.current_milli_time(), {})\n\nanomalyVerificationSuite = VerificationSuite(spark_session) \\\n    .onData(df) \\\n    .useRepository(metricsRepository) \\\n    .addAnomalyCheck(RelativeRateOfChangeStrategy(maxRateIncrease = 2.0), Size())\n\ncancel_job_if_failing_quality_checks(VerificationResult.checkResultsAsDataFrame(spark_session, anomalyVerificationSuite.run()))\n\n# Only update the metrics repository if cancel_job_if_failing_quality_checks succeeds.\n# Otherwise the next time anomaly check runs it will compare against "incorrect" metrics.\nanomalyVerificationSuite.saveOrAppendResult(resultKey).run()\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Here is a ",(0,n.jsx)(t.a,{href:"https://pydeequ.readthedocs.io/en/latest/pydeequ.html#module-pydeequ.anomaly_detection",children:"list of anomaly detection types"})," that are available to use."]}),"\n",(0,n.jsx)(t.h2,{id:"providing-tags-to-metrics-for-verification-constraint-checks",children:"Providing tags to metrics for verification constraint checks"}),"\n",(0,n.jsxs)(t.p,{children:["You can add tags to your verification metrics which may be helpful when reviewing the metric\nresults for a particular job.\nTo do this, include a dictionary containing key value pairs in the ",(0,n.jsx)(t.code,{children:"ResultKey"})," as shown in example below:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'import sys\nfrom awsglue.utils import getResolvedOptions\n\nargs = getResolvedOptions(sys.argv, [\'JOB_NAME\'])\n\nresultKey = ResultKey(spark_session, ResultKey.current_milli_time(), {\n    "source_database": source_catalog_database,\n    "source_table": source_catalog_table,\n    "glue_job_id": args[\'JOB_RUN_ID\']\n})\n'})}),"\n",(0,n.jsx)(t.h2,{id:"stopping-glue-jobs-when-constraint-checks-fail",children:"Stopping Glue jobs when constraint checks fail"}),"\n",(0,n.jsx)(t.p,{children:"In order to ensure that only trusted data is outputted from your Glue job, it is important\nto make an assertion against your constraints to check that they have been satisfied."}),"\n",(0,n.jsxs)(t.p,{children:["You can do this by including a helper function called ",(0,n.jsx)(t.code,{children:"cancel_job_if_failing_quality_checks()"}),"\nin your script (see ",(0,n.jsx)(t.a,{href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/scripts/helpers/data_quality_testing.py",children:"data quality testing helpers"})," for more info).\nYou can see an example usage in the ",(0,n.jsx)(t.a,{href:"#2-historical-analysis-of-the-dataset---example-anomaly-detection",children:"Historical analysis of the dataset - Example Anomaly Detection"})," section."]}),"\n",(0,n.jsx)(t.p,{children:"When a constraint check fails, the Glue job will fail and, an error message will be provided which might look something like\nthe below message:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-markdown",children:"Exception: data quality checks. Value: 1.0 does not meet the constraint requirement!\nThe minimum(work_priority_priority_code) >= 2\n| Anomaly check for Size(None). Value: 486.0 does not meet the constraint requirement!\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Multiple constraint failures are delimited by a ",(0,n.jsx)(t.code,{children:"|"})," character in the error message."]}),"\n",(0,n.jsx)(t.h2,{id:"commit-your-data-quality-tests-to-your-glue-job",children:"Commit your data quality tests to your Glue job"}),"\n",(0,n.jsx)(t.p,{children:"Once you are satisfied with your data quality tests, you will need to commit them to the Data Platform project so that they can be deployed to your existing Glue job."}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Submit your changes by referring to the ",(0,n.jsx)(t.a,{href:"../../getting-set-up/using-github#committing-your-changes-to-the-data-platform-project",children:"Committing changes"})," section of the ",(0,n.jsx)(t.strong,{children:"Using Github"})," guide.\nThe Data Platform team needs to approve any changes to the code, so your change won't happen automatically."]}),"\n"]}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsxs)(t.p,{children:["If you are working with a new Glue job that has not yet been deployed to the Data Platform project, refer to ",(0,n.jsx)(t.a,{href:"../using-aws-glue/deploy-glue-jobs",children:"this guide"})," to have it added to the project."]})}),"\n",(0,n.jsx)(t.h2,{id:"email-notifications-of-failing-glue-jobs",children:"Email notifications of failing Glue jobs"}),"\n",(0,n.jsx)(t.p,{children:"Each time a Glue job fails as a result of failing constraint checks, an email notification with details of the error message is sent to the respective department, and their subscribed members."}),"\n",(0,n.jsx)(t.p,{children:"The message will include:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Name of the Glue job"}),"\n",(0,n.jsx)(t.li,{children:"Error message from the failing constraint check"}),"\n",(0,n.jsx)(t.li,{children:"Time of failure"}),"\n",(0,n.jsx)(t.li,{children:"Job start time"}),"\n",(0,n.jsx)(t.li,{children:"Job end time"}),"\n",(0,n.jsx)(t.li,{children:"Job last modified time"}),"\n",(0,n.jsx)(t.li,{children:"A link to log in to Hackney SSO and view the Job run details"}),"\n"]}),"\n",(0,n.jsxs)(t.p,{children:["In order to receive email notifications, you will need to ensure that you are subscribed to receive emails from your department's ",(0,n.jsx)(t.a,{href:"https://groups.google.com/my-groups",children:"Google group"})," and that you have confirmed your subscription to receive AWS Notifications when prompted."]}),"\n",(0,n.jsx)(t.p,{children:"Additionally, Spark Web UI is used to monitior and debug the glue jobs. Every 30 seconds, AWS Glue flushes the Spark event logs to an S3 bucket titled Spark UI Bucket."}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsxs)(t.p,{children:["If you are still prototyping your data quality tests in Glue Studio, ensure the ",(0,n.jsx)(t.strong,{children:"PlatformDepartment"})," tag is correctly set in the ",(0,n.jsx)(t.em,{children:"Advanced details"})," section in the Glue job's ",(0,n.jsx)(t.em,{children:"Job Details"})," (see ",(0,n.jsx)(t.a,{href:"../using-aws-glue/using-glue-studio",children:"Using Glue Studio"}),")."]})})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},8453:(e,t,i)=>{i.d(t,{R:()=>o,x:()=>r});var n=i(6540);const s={},a=n.createContext(s);function o(e){const t=n.useContext(a);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);