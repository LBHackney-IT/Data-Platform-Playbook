"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[3585],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>f});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),m=p(a),u=r,f=m["".concat(s,".").concat(u)]||m[u]||d[u]||o;return a?n.createElement(f,l(l({ref:t},c),{},{components:a})):n.createElement(f,l({ref:t},c))}));function f(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,l=new Array(o);l[0]=u;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[m]="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},4487:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var n=a(7462),r=(a(7294),a(3905));const o={title:"Alloy data ingestion",description:"Description of the ingestion and refinement pipeline for Alloy Environmental Services data",layout:"playbook_js",tags:["playbook"]},l="This article describes the Alloy data ingestion process.",i={unversionedId:"docs/alloy-ingestion",id:"docs/alloy-ingestion",title:"Alloy data ingestion",description:"Description of the ingestion and refinement pipeline for Alloy Environmental Services data",source:"@site/docs/docs/alloy-ingestion.md",sourceDirName:"docs",slug:"/docs/alloy-ingestion",permalink:"/Data-Platform-Playbook/docs/alloy-ingestion",draft:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/docs/alloy-ingestion.md",tags:[{label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",frontMatter:{title:"Alloy data ingestion",description:"Description of the ingestion and refinement pipeline for Alloy Environmental Services data",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Ingesting Academy data onto the Data Platform",permalink:"/Data-Platform-Playbook/docs/academy-ingestion"},next:{title:"Auto-adjusting AWS Budget Alerts",permalink:"/Data-Platform-Playbook/docs/auto-adjusting-aws-budget"}},s={},p=[{value:"Overview of process",id:"overview-of-process",level:2},{value:"Retrieving a data extract from the Alloy API",id:"retrieving-a-data-extract-from-the-alloy-api",level:2},{value:"Creating the refined tables",id:"creating-the-refined-tables",level:2},{value:"Pipeline creation in Terraform",id:"pipeline-creation-in-terraform",level:2}],c={toc:p},m="wrapper";function d(e){let{components:t,...o}=e;return(0,r.kt)(m,(0,n.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"this-article-describes-the-alloy-data-ingestion-process"},"This article describes the Alloy data ingestion process."),(0,r.kt)("h2",{id:"overview-of-process"},"Overview of process"),(0,r.kt)("p",null,"The following diagram describes the process steps that make up the pipeline for ingesting Alloy data:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Alloy data ingestion process",src:a(250).Z,width:"1061",height:"717"})),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"An initial Glue job triggered on a schedule",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"requests the export described in AQS (Alloy query syntax) from the API"),(0,r.kt)("li",{parentName:"ul"},"extracts the csv tables from the returned zip file and saves them to the ",(0,r.kt)("em",{parentName:"li"},"raw zone")," in S3"),(0,r.kt)("li",{parentName:"ul"},"applies only a necessary amount of transformation to save a copy of the data as parquet files also to s3"))),(0,r.kt)("li",{parentName:"ul"},"On job completion, a crawler updates tables in the env-services-raw Glue Catalog with the new parquet files"),(0,r.kt)("li",{parentName:"ul"},"A second Glue job then creates Dynamic Frames for all unprocessed parquet files for each table in the raw zone",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"this job then checks for a column name dictionary in S3 then applies a mapping if one is found"),(0,r.kt)("li",{parentName:"ul"},"the transformed data is then exported to the refined zone and saved to s3"))),(0,r.kt)("li",{parentName:"ul"},"This data is then crawled and made available in the ",(0,r.kt)("em",{parentName:"li"},"refined zone")," Catalog")),(0,r.kt)("h2",{id:"retrieving-a-data-extract-from-the-alloy-api"},"Retrieving a data extract from the Alloy API"),(0,r.kt)("p",null,"  ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/scripts/jobs/env_services/alloy_api_ingestion.py"},(0,r.kt)("em",{parentName:"a"},"This Glue job"))," sends queries to the Alloy API that request an extract of datasets described in ",(0,r.kt)("a",{parentName:"p",href:"https://help.alloyapp.io/alloy-query-syntax/alloy-query-syntax.html"},"Alloy Query Syntax (AQS)"),". These queries are stored in json format and uploadeded to ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/tree/main/scripts/jobs/env_services/aqs"},"this directory in the Data Platform GitHub repository"),"."),(0,r.kt)("p",null,"Each query creates a new job for that dataset that runs independently of any other queries.  "),(0,r.kt)("p",null,"A request is sent to the API and once the export is complete the data is downloaded and extracted as a zip file containing csvs that are saved in S3. These csvs then read from the S3 bucket to a spark data frame. Minimal transformation is applied to allow for conversion to parquet format and import datetime columns are added. "),(0,r.kt)("h2",{id:"creating-the-refined-tables"},"Creating the refined tables"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/scripts/jobs/env_services/alloy_raw_to_refined.py"},(0,r.kt)("em",{parentName:"a"},"The second Glue job"))," looks for tables in the ",(0,r.kt)("em",{parentName:"p"},"env-services-raw-zone"),' Glue Catalog database with a given prefix of the form "parent table name_".'),(0,r.kt)("p",null,"It then iterates over each of the sub-tables to process any parquet files in the raw zone that have been created since the last run (identified using the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/glue/latest/dg/monitor-continuations.html"},"job bookmarking feature"),"). "),(0,r.kt)("p",null,"As part of the refining process, the job checks for a json dictionary stored in s3 under the raw bucket with a key formed like this:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"env-services/alloy/mapping-files/parent table name_table_name.json")),(0,r.kt)("p",null,"The json is of the form:"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"{",(0,r.kt)("br",null),'\n"old_name1": "new_name1",',(0,r.kt)("br",null),'\n"old_name2": "new_name2",',(0,r.kt)("br",null),"\n...\n}")),(0,r.kt)("p",null,"If a key is not present in the table no action will be taken, and similarly if there is no key for a column that is present in the table it remains unchanged. "),(0,r.kt)("p",null,"Column names are cleaned to conform to requirements for parquet formatted files. Refined date columns are added. Then the resultant DynamicFrames are written to the ",(0,r.kt)("em",{parentName:"p"},"Refined Zone"),". "),(0,r.kt)("h2",{id:"pipeline-creation-in-terraform"},"Pipeline creation in Terraform"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/terraform/etl/25-alloy-etl-env-services.tf"},"The Terraform")," will create a complete pipeline and triggers for each AQS json file added to the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/tree/main/scripts/jobs/env_services/aqs"},"aqs directory in the Data-Platform repository"),"."),(0,r.kt)("p",null,'The naming of these files dictates the names for the resources in AWS. Adding an AQS query in a file called "Parent Table.json" will create:'),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"A Glue trigger:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Alloy API Export Job Trigger ",(0,r.kt)("strong",{parentName:"li"},"Parent Table")))),(0,r.kt)("li",{parentName:"ul"},"2 Glue jobs:",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"alloy",(0,r.kt)("em",{parentName:"li"},"api_export"),(0,r.kt)("strong",{parentName:"li"},"Parent Table"),"_env_services"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Parent Table"),"_alloy_daily_raw_to_refined_env_services"))),(0,r.kt)("li",{parentName:"ul"},"2 Crawlers",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"Alloy Export Crawler ",(0,r.kt)("strong",{parentName:"li"},"Parent Table")),(0,r.kt)("li",{parentName:"ul"},"Alloy Refined Crawler ",(0,r.kt)("strong",{parentName:"li"},"Parent Table"))))),(0,r.kt)("p",null,"Removing files from this location will result in the related AWS resources also being destroyed when the Terraform in applied."))}d.isMDXComponent=!0},250:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/alloy_pipeline-7e59a4787d4203e9ea525f7287a91da6.png"}}]);