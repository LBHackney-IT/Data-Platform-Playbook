"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[9399],{8648:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>d});var i=n(4848),o=n(8453);const r={title:"Tips on writing an API Ingestion script for AWS Lambda",description:"Recommendations to write an API ingestion script for a Lambda in the Data Platform",layout:"playbook_js",tags:["playbook"]},a="Tips on writing an API Ingestion script for AWS Lambda",s={id:"playbook/ingesting-data/tips-on-how-to-write-an-API-Lambda-script",title:"Tips on writing an API Ingestion script for AWS Lambda",description:"Recommendations to write an API ingestion script for a Lambda in the Data Platform",source:"@site/docs/playbook/ingesting-data/011-tips-on-how-to-write-an-API-Lambda-script.md",sourceDirName:"playbook/ingesting-data",slug:"/playbook/ingesting-data/tips-on-how-to-write-an-API-Lambda-script",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/tips-on-how-to-write-an-API-Lambda-script",draft:!1,unlisted:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/playbook/ingesting-data/011-tips-on-how-to-write-an-API-Lambda-script.md",tags:[{inline:!0,label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",sidebarPosition:11,frontMatter:{title:"Tips on writing an API Ingestion script for AWS Lambda",description:"Recommendations to write an API ingestion script for a Lambda in the Data Platform",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Production to pre-production data sync",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/production-to-pre-production-sync"},next:{title:"Using Watermarks to Record AWS GLue Job States Between Runs",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/using-watermarks-to-record-job-states"}},l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Introduction",id:"introduction",level:2},{value:"Writing the Code for the Data Platform",id:"writing-the-code-for-the-data-platform",level:2},{value:"Desired End Output",id:"desired-end-output",level:3},{value:"Basic Rules",id:"basic-rules",level:3},{value:"Some tips",id:"some-tips",level:3},{value:"Integrating S3",id:"integrating-s3",level:2},{value:"Obtaining Secrets from the Secrets Manager",id:"obtaining-secrets-from-the-secrets-manager",level:3},{value:"Reading files in S3 Bucket",id:"reading-files-in-s3-bucket",level:3},{value:"Output to S3 Landing Zone",id:"output-to-s3-landing-zone",level:3},{value:"Generating a Piplock and Requirements.txt File",id:"generating-a-piplock-and-requirementstxt-file",level:2},{value:"Update the Data Platform with our Script",id:"update-the-data-platform-with-our-script",level:2}];function c(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components},{Details:n}=t;return n||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"tips-on-writing-an-api-ingestion-script-for-aws-lambda",children:"Tips on writing an API Ingestion script for AWS Lambda"})}),"\n",(0,i.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:'Have the secrets/api_key stored in both Production and Pre-Production environments, with the naming convention of "/[Department Name]/[secret name]". So for example, /customer-services/vonage'}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(t.p,{children:"This is an article on tips to write, format your Python script, to be used in Lambda for the Data Platform."}),"\n",(0,i.jsx)(t.h2,{id:"writing-the-code-for-the-data-platform",children:"Writing the Code for the Data Platform"}),"\n",(0,i.jsx)(t.p,{children:"You can use whatever you want to make the Python Script. However to have it run in the Data Platform, there are a few rules to keep in mind if you intend for this script to be used in AWS Lambda."}),"\n",(0,i.jsx)(t.h3,{id:"desired-end-output",children:"Desired End Output"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:".Py File"}),"\n",(0,i.jsx)(t.li,{children:"Code which can be run frequently. Lambdas have a timeout limit of 15 minutes, so the code must complete within this time. It's therefore likely you'll want your code to run daily."}),"\n",(0,i.jsxs)(t.li,{children:["Outputs the ",(0,i.jsx)(t.strong,{children:"RAW CONTENT"})," of the API call. No transformations"]}),"\n",(0,i.jsxs)(t.li,{children:["Outputs the content in ",(0,i.jsx)(t.code,{children:" {folder}/import_year={year}/import_month={month}/import_day={day}/import_date={date}/"})]}),"\n",(0,i.jsx)(t.li,{children:"The dates refer to the date of import, not the date of the Data"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"basic-rules",children:"Basic Rules"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"The Python Script needs to be able to determine, on its own, which date range to pull data from"}),"\n",(0,i.jsxs)(t.li,{children:['The Lambda will run the "Lambda_handler" function. This means in place of ',(0,i.jsx)(t.code,{children:"__MAIN__()"})," you will have ",(0,i.jsx)(t.code,{children:"def lambda_handler(event, lambda_context):"}),". Then to run this script, you just have a ",(0,i.jsx)(t.code,{children:'lambda_handler("","")'})," line"]}),"\n",(0,i.jsxs)(t.li,{children:["If you have variables which you want the Terraform or Glue job to handle, you can pass them through as environment variables instead. ",(0,i.jsx)(t.code,{children:'os.environ["TARGET_S3_BUCKET_NAME"] = "landing-zone"'}),"  for example will set the environment variable ",(0,i.jsx)(t.code,{children:"TARGET_S3_BUCKET_NAME"})," to ",(0,i.jsx)(t.code,{children:"landing-zone"}),". ",(0,i.jsx)(t.code,{children:'s3_bucket = getenv("TARGET_S3_BUCKET_NAME")'})," Will then be the code to get the environment variable as a variable in your script"]}),"\n",(0,i.jsx)(t.li,{children:"Have no secrets (e.g. API keys) hard coded into the script"}),"\n",(0,i.jsx)(t.li,{children:"Try to use as little external packages as possible, Pandas is around 50mb after you install all of the dependancies. Very expensive"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"some-tips",children:"Some tips"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["If you are coding using .py files, the way I have found to code the script is to have 2 separate scripts. One main.py file which has the code to go into the Lambda. Another script which triggers that one and sets environment variables - In Jupyter (So Google Colab). Instead of making multiple scripts, use multiple cells. This is what I would suggest","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Import cell"}),"\n",(0,i.jsx)(t.li,{children:"Functions cell"}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"lambda_handler(event, lambda_context):"})," which acts as your main(), and interacts with the functions cell"]}),"\n",(0,i.jsx)(t.li,{children:'A cell with lambda_handler("","") and environment variable setters to trigger above. This will not be copied into your .py script when it comes down to making it in the Data Platform but it\'s what will help trigger your Lambda Handler event'}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Example Jupyter Script Format"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"import os\n"})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"def print_text(text_string):\n\tprint(text_string)\n"})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'def lambda_handler(event, lambda_context):\n\tload_dotenv() # load environment variables\n\tstring_to_print = getenv("STRING_TO_PRINT")\n\tprint_text(string_to_print)\n\n'})}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'import os\nos.environ["STRING_TO_PRINT"] = "Bacon" # Variable to be passed via Terraform\nlambda_handler("","")\n'})})]}),"\n",(0,i.jsx)(t.p,{children:"Once you have your script able to output data from the API locally, we need to modify the script to output to S3."}),"\n",(0,i.jsx)(t.h2,{id:"integrating-s3",children:"Integrating S3"}),"\n",(0,i.jsxs)(t.p,{children:["For our Python script to output data into the Data Platform, we will use a Python Module called ",(0,i.jsx)(t.a,{href:"https://boto3.amazonaws.com/v1/documentation/api/1.9.42/index.html#:~:text=Boto%203%20Documentation%C2%B6%20Boto%20is%20the%20Amazon%20Web,to%20use%2C%20object-oriented%20API%20as%20well%20as%20low-level",children:"Boto3"})]}),"\n",(0,i.jsx)(t.p,{children:"While it has many features, we will focus on 3 of them"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Obtaining secrets from Secrets Manager"}),"\n",(0,i.jsx)(t.li,{children:"Reading files in S3 Bucket"}),"\n",(0,i.jsx)(t.li,{children:"Outputting to S3"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["However Boto3 does not work unless you authenticate Boto3. There are many ways to do so, follow one of these methods found ",(0,i.jsx)(t.a,{href:"https://boto3.amazonaws.com/v1/documentation/api/1.9.42/guide/configuration.html#guide-configuration",children:"Here"})]}),"\n",(0,i.jsx)(t.p,{children:"Once you have authenticated Boto3. Lets use some AWS functionality"}),"\n",(0,i.jsx)(t.h3,{id:"obtaining-secrets-from-the-secrets-manager",children:"Obtaining Secrets from the Secrets Manager"}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Code to get Secrets from S3"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'secrets_manager_client = boto3.client(\'secretsmanager\')\n\nsecret_name = getenv("SECRET_NAME")\n\nsecret_manager_response = secrets_manager_client.get_secret_value(SecretId=secret_name)\napi_credentials = json.loads(secret_manager_response[\'SecretString\'])\n\napi_key = api_credentials.get("api_key")\nsecret = api_credentials.get("secret")\n'})})]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Create a secrets manager client with boto3"}),"\n",(0,i.jsx)(t.li,{children:"Pull the secret_name from environment variables."}),"\n"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["In local environment we can give this to the script using ",(0,i.jsx)(t.code,{children:'os.environ["SECRET_NAME"] = "Some Value"'}),"."]}),"\n",(0,i.jsx)(t.li,{children:"In the Data Platform, we will give the secret name to the script via Terraform later"}),"\n"]}),"\n",(0,i.jsxs)(t.ol,{start:"3",children:["\n",(0,i.jsx)(t.li,{children:"Make an API request to the Secrets Manager client, this will return a response"}),"\n",(0,i.jsx)(t.li,{children:"Load the Secret String portion of the response ['SecretString']"}),"\n",(0,i.jsx)(t.li,{children:"Get the API Key and Secret"}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"reading-files-in-s3-bucket",children:"Reading files in S3 Bucket"}),"\n",(0,i.jsx)(t.p,{children:"You may want to read what files that you have in an S3 Bucket, maybe to determine what data you already have, or maybe to actually read one"}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Code to List folders"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"s3_client = boto3.client('s3')\n\ndef list_subfolders_in_directory(s3_client,bucket,directory):\n\t\tresponse = s3_client.list_objects_v2(\n\t\t\t\tBucket=bucket,\n\t\t\t\tPrefix=directory,\n\t\t\t\tDelimiter=\"/\")\n\n\t\tsubfolders = response.get('CommonPrefixes')\n\t\treturn subfolders\n"})})]}),"\n",(0,i.jsx)(t.p,{children:"Returns a list of folders at a specific path."}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Code to List Files"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'s3_client = boto3.client(\'s3\')\nbucket = "Bucket name"\ndirectory = "Path to where you want to list the files, ending with /"\n\ndef list_s3_files_in_folder_using_client(s3_client,bucket,directory):\n\n\tresponse = s3_client.list_objects_v2(Bucket=bucket, Prefix=directory)\n\tfiles = response.get("Contents")\n\n\tfor file in files:\n\t\tfile[\'Key\'] = re.sub(string=file[\'Key\'],\n\t\t\t\t\t\tpattern=f"{directory}/".format(),\n\t\t\t\t\t\trepl="")\n\t# returns a list of dictionaries with file metadata\n\treturn files\n'})})]}),"\n",(0,i.jsx)(t.p,{children:"Returns a list of files at a specific path."}),"\n",(0,i.jsx)(t.h3,{id:"output-to-s3-landing-zone",children:"Output to S3 Landing Zone"}),"\n",(0,i.jsx)(t.p,{children:"Here I will supply and explain two functions which will help you put files into S3"}),"\n",(0,i.jsxs)(n,{children:[(0,i.jsx)("summary",{children:"Output to Landing zone with Formatting"}),(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'from datetime import date\n\ndef output_to_landing_zone(s3_bucket, data, output_folder,filename):\n\t\ttodays_date = date.today()\n\n\t\tday = todays_date.day.zfill(2)\n\t\tmonth = todays_date.month.zfill(2)\n\t\tyear = str(todays_date.year)\n\n\t\treturn s3_client.put_object(\n\t\t\t\tBucket=s3_bucket,\n\t\t\t\tBody=str(data),\n\t\t\t\tKey=f"{output_folder}/import_year={year}/import_month={month}/import_day={day}/import_date={todays_date}/{filename}.json")\n'})})]}),"\n",(0,i.jsxs)(t.p,{children:['So if you wanted to put a json file into the "',(0,i.jsx)(t.strong,{children:"Sandbox"}),'" bucket, and within that bucket, you want the data to be within the "',(0,i.jsx)(t.strong,{children:"CRM"}),'" folder, you would call the function with']}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsx)(t.code,{children:'output_to_landing_zone(s3_bucket, <the json data>, "**CRM**", "**Sandbox**"). '})}),"\n",(0,i.jsx)(t.p,{children:"It will then proceed to put the Data into the Data Platform. It will use today as the import day and create the correct folder structure for it to work. Note that the import_date is in YYYYMMDD format not YYYY-MM-DD"}),"\n",(0,i.jsx)(t.p,{children:"Once you get the code, try running the code using Pre-Prod credentials to output to Pre-Prod"}),"\n",(0,i.jsx)(t.h2,{id:"generating-a-piplock-and-requirementstxt-file",children:"Generating a Piplock and Requirements.txt File"}),"\n",(0,i.jsx)(t.p,{children:"For your Python script to work, you will most likely need to download extra packages to use, packages which are not built in to Python"}),"\n",(0,i.jsx)(t.p,{children:"To do this, we will create a requirements.txt file, and from the requirements.txt file, we will generate a Piplock file. This Piplock file is what tells the Terraform (Which creates Lambdas) which external packages to give to the environment which will run your Python Script"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"Install Pipreqs"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["Generally something like ",(0,i.jsx)(t.code,{children:"pip install pipreqs"})," would be fine"]}),"\n",(0,i.jsxs)(t.ol,{start:"2",children:["\n",(0,i.jsx)(t.li,{children:"Open command prompt at the location of your Python Script"}),"\n",(0,i.jsxs)(t.li,{children:["Use the command ",(0,i.jsx)(t.code,{children:"pipreqs"})]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["This creates a ",(0,i.jsx)(t.code,{children:"requirements.txt"})," file. It contains all of the packages and dependancies you need for your script"]}),"\n",(0,i.jsxs)(t.ol,{start:"4",children:["\n",(0,i.jsx)(t.li,{children:"Install Pipenv"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"pip install pipenv"})," works"]}),"\n",(0,i.jsxs)(t.ol,{start:"5",children:["\n",(0,i.jsxs)(t.li,{children:["Use the command ",(0,i.jsx)(t.code,{children:"pipenv lock"})]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["This will now create a ",(0,i.jsx)(t.code,{children:"pipfile"})," and ",(0,i.jsx)(t.code,{children:"pipfile.lock"}),". These are what the Terraform needs to create your Lambda."]}),"\n",(0,i.jsxs)(t.ol,{start:"6",children:["\n",(0,i.jsxs)(t.li,{children:["Open your ",(0,i.jsx)(t.code,{children:"pipfile"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["Move boto3 and botocore rows to ",(0,i.jsx)(t.code,{children:"[dev-packages]"})]}),"\n",(0,i.jsx)(t.li,{children:'Replace the contents of all of the package versions with "*" instead'}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For example. ",(0,i.jsx)(t.code,{children:'boto3 = "==1.24.89"'})," would become ",(0,i.jsx)(t.code,{children:'boto3 = "*"'})," instead"]}),"\n",(0,i.jsxs)(t.ol,{start:"9",children:["\n",(0,i.jsx)(t.li,{children:'Change the python version to "3"'}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"So now we have a script which outputs files into AWS S3, we have the piplock file which lets the Terraform know what packages we need. We now need to push the script to the dataplatform so that we can begin to use it"}),"\n",(0,i.jsx)(t.h2,{id:"update-the-data-platform-with-our-script",children:"Update the Data Platform with our Script"}),"\n",(0,i.jsx)(t.p,{children:"The best practise way is to clone the project into your IDE, create the files in the right place, then push it back to the Data Platform to be merged into the main branch"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"If you do not have a copy of the Data Platform in your IDE environment already, clone the Data Platform"}),"\n",(0,i.jsxs)(t.li,{children:["Navigate to ",(0,i.jsx)(t.code,{children:"lambdas"})]}),"\n",(0,i.jsxs)(t.li,{children:["Create a folder for your script. Named something like ",(0,i.jsx)(t.code,{children:"something_api_ingestion"}),". All lowercase and underscores replacing spaces"]}),"\n",(0,i.jsxs)(t.li,{children:["Either create or copy your ",(0,i.jsx)(t.code,{children:"main.py"})," script in this folder. Do the same with the ",(0,i.jsx)(t.code,{children:"pipfile"})," and ",(0,i.jsx)(t.code,{children:"pipfile.lock"}),"."]}),"\n",(0,i.jsx)(t.li,{children:"Commit and Push into the Data Platform, then make a Pull Request. Your code will need to be reviewed by someone else before it can be put into Live."}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>a,x:()=>s});var i=n(6540);const o={},r=i.createContext(o);function a(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);