"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[5721],{3905:function(e,t,a){a.d(t,{Zo:function(){return c},kt:function(){return p}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var i=n.createContext({}),d=function(e){var t=n.useContext(i),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=d(e.components);return n.createElement(i.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,i=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),h=d(a),p=r,m=h["".concat(i,".").concat(p)]||h[p]||u[p]||o;return a?n.createElement(m,s(s({ref:t},c),{},{components:a})):n.createElement(m,s({ref:t},c))}));function p(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,s=new Array(o);s[0]=h;var l={};for(var i in t)hasOwnProperty.call(t,i)&&(l[i]=t[i]);l.originalType=e,l.mdxType="string"==typeof e?e:r,s[1]=l;for(var d=2;d<o;d++)s[d]=a[d];return n.createElement.apply(null,s)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},3532:function(e,t,a){a.r(t),a.d(t,{assets:function(){return c},contentTitle:function(){return i},default:function(){return p},frontMatter:function(){return l},metadata:function(){return d},toc:function(){return u}});var n=a(3117),r=a(102),o=(a(7294),a(3905)),s=["components"],l={title:"Redshift - Creating users, databases and exposing data from Glue",description:"",layout:"playbook_js",tags:["playbook"]},i=void 0,d={unversionedId:"docs/redshift",id:"docs/redshift",title:"Redshift - Creating users, databases and exposing data from Glue",description:"",source:"@site/docs/docs/redshift.md",sourceDirName:"docs",slug:"/docs/redshift",permalink:"/Data-Platform-Playbook/docs/redshift",draft:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/docs/redshift.md",tags:[{label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",frontMatter:{title:"Redshift - Creating users, databases and exposing data from Glue",description:"",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Liberator data ingestion",permalink:"/Data-Platform-Playbook/docs/liberator-ingestion"},next:{title:"RingGo data ingestion",permalink:"/Data-Platform-Playbook/docs/ringgo-ingestion"}},c={},u=[{value:"Objective / Who is this for?",id:"objective--who-is-this-for",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Collection Structure",id:"collection-structure",level:2},{value:"Open Redshift Query Editor",id:"open-redshift-query-editor",level:2},{value:"Connect to the Database",id:"connect-to-the-database",level:2},{value:"Create a User",id:"create-a-user",level:2},{value:"Generating strong password",id:"generating-strong-password",level:3},{value:"Sharing the password with the user",id:"sharing-the-password-with-the-user",level:3},{value:"External Schema",id:"external-schema",level:2},{value:"Adding an External Schema requirements",id:"adding-an-external-schema-requirements",level:3},{value:"Finding the name of the AWS Glue Database to be added",id:"finding-the-name-of-the-aws-glue-database-to-be-added",level:2},{value:"Finding the IAM Role details",id:"finding-the-iam-role-details",level:2},{value:"Adding an External Schema",id:"adding-an-external-schema",level:3},{value:"Granting a User Access",id:"granting-a-user-access",level:3},{value:"Role based access control (RBAC)",id:"role-based-access-control-rbac",level:2},{value:"Roles management",id:"roles-management",level:3},{value:"Users permission to roles",id:"users-permission-to-roles",level:3},{value:"Storing the credentials of the created user in a parameters store",id:"storing-the-credentials-of-the-created-user-in-a-parameters-store",level:3},{value:"How do we know if it worked?",id:"how-do-we-know-if-it-worked",level:3},{value:"Related documents",id:"related-documents",level:3}],h={toc:u};function p(e){var t=e.components,a=(0,r.Z)(e,s);return(0,o.kt)("wrapper",(0,n.Z)({},h,a,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"objective--who-is-this-for"},"Objective / Who is this for?"),(0,o.kt)("p",null,"After this article, you should be able to"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create a user in redshift"),(0,o.kt)("li",{parentName:"ul"},"Create a schema for your tables"),(0,o.kt)("li",{parentName:"ul"},"Grant permissions to a user to view the tables"),(0,o.kt)("li",{parentName:"ul"},"Make the connection with an AWS Glue database to see the data in the tables")),(0,o.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,o.kt)("p",null,"In order to complete this article, you will need"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Permissions to configure Redshift"),(0,o.kt)("li",{parentName:"ul"},"Access to Amazon Redshift"),(0,o.kt)("li",{parentName:"ul"},"Access to Amazon Glue Databases")),(0,o.kt)("h2",{id:"collection-structure"},"Collection Structure"),(0,o.kt)("p",null,"Unlike most Database services. Redshift has a three tier collection setup:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"The top most tier is called a Database, a Database contains multiple Schemas"),(0,o.kt)("li",{parentName:"ol"},"The second tier is called a Schema, a Schema contains multiple Tables"),(0,o.kt)("li",{parentName:"ol"},"The final tier is called a Table, a Table contains multiple rows of data or references a location in S3")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Database -> Schema -> Table")),(0,o.kt)("h2",{id:"open-redshift-query-editor"},"Open Redshift Query Editor"),(0,o.kt)("p",null,'Use the search bar at the top of AWS to search for Redshift. Then on the left, go to "Editor" then "Query Editor". You will enter the code here.'),(0,o.kt)("h2",{id:"connect-to-the-database"},"Connect to the Database"),(0,o.kt)("p",null,"You must have an open connection to see the tables."),(0,o.kt)("h2",{id:"create-a-user"},"Create a User"),(0,o.kt)("p",null,"To create a new user in Redshift, run the following command as a query:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER {username} WITH PASSWORD '{password}';\n")),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE USER housing_repairs WITH PASSWORD 'th1s1sANEx&mpl3';\n")),(0,o.kt)("p",null,"If you are creating new users to be used with roled based access control please use user's Hackney email address as their username. When creating email based usernames the username in the SQL command must be wrapped in double quotes. "),(0,o.kt)("h3",{id:"generating-strong-password"},"Generating strong password"),(0,o.kt)("p",null,"New password can be generated using the ",(0,o.kt)("a",{parentName:"p",href:"https://1password.com/password-generator"},"1Password online password generator"),". These are the recommended settings:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Password type: Random Password"),(0,o.kt)("li",{parentName:"ol"},"Length: 30"),(0,o.kt)("li",{parentName:"ol"},"Tick both 'Numbers' and 'Symbols' checkboxes")),(0,o.kt)("h3",{id:"sharing-the-password-with-the-user"},"Sharing the password with the user"),(0,o.kt)("p",null,"Once the user has been created the initial password needs to be shared with them securely and they must also be asked to change it."),(0,o.kt)("p",null,"To share the created password with the user please follow these steps:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Add the password to your private vault in 1Password"),(0,o.kt)("li",{parentName:"ol"},"Click on the share icon on the toolbar"),(0,o.kt)("li",{parentName:"ol"},"Set the 'Link expires after' value to '7 days'"),(0,o.kt)("li",{parentName:"ol"},"Set the 'Available to' value to 'Only some people'"),(0,o.kt)("li",{parentName:"ol"},"Tick the 'Can be viewed only 1 time per person' box"),(0,o.kt)("li",{parentName:"ol"},"Type user's Hackney email address to the 'Email addresses for the people to share this with:' field"),(0,o.kt)("li",{parentName:"ol"},"Click on 'Get link to share'"),(0,o.kt)("li",{parentName:"ol"},"Use the 'Copy' option in the popup to get the shareable link and email it to the user's Hackney email address")),(0,o.kt)("p",null,"Once the link has been shared user can follow these steps to receive the password:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Open the link in the email from 1Password"),(0,o.kt)("li",{parentName:"ol"},"Verify your email address by filling in the details on the page and click 'Send code'"),(0,o.kt)("li",{parentName:"ol"},"Wait for the code to arrive and paste it to the 'Verification code' field"),(0,o.kt)("li",{parentName:"ol"},"Copy the provided password from the page. Please note the password can be retrieved only once"),(0,o.kt)("li",{parentName:"ol"},"Use the provided password to connect to Redshift from your BI tool and use the SQL command below to change it. Please see the ",(0,o.kt)("a",{parentName:"li",href:"#Generating-strong-password"},'"Generating strong password"')," section for advice on how to generate strong password")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER USER {username} password '{new-password}'; \n")),(0,o.kt)("h2",{id:"external-schema"},"External Schema"),(0,o.kt)("p",null,"Redshift Spectrum is able to access data in S3 that has been cataloged via AWS Glue by creating an external\nschema. An external schema acts like a database but instead of holding the data within the redshift cluster it uses an\nattached IAM role to read the data from S3."),(0,o.kt)("h3",{id:"adding-an-external-schema-requirements"},"Adding an External Schema requirements"),(0,o.kt)("p",null,"To create an External Schema you will need the name of the AWS Glue Database to be added. An IAM role that can be used\nto read the data from S3 (A role has been included in the Data Platform) and a schema name that the database will be\ndisplayed as."),(0,o.kt)("h2",{id:"finding-the-name-of-the-aws-glue-database-to-be-added"},"Finding the name of the AWS Glue Database to be added"),(0,o.kt)("p",null,"Navigate to AWS Glue and retrieve the name of the database you want to expose in Redshift. The example below uses 'housing-repairs-raw-zone'."),(0,o.kt)("h2",{id:"finding-the-iam-role-details"},"Finding the IAM Role details"),(0,o.kt)("p",null,"Use the appropriate IAM role that you will find in the IAM console in AWS."),(0,o.kt)("h3",{id:"adding-an-external-schema"},"Adding an External Schema"),(0,o.kt)("p",null,"Execute the following SQL against the Redshift Cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"CREATE EXTERNAL SCHEMA {schema-name}\n    FROM DATA CATALOG\n    DATABASE '{aws-glue-database}'\n    IAM_ROLE 'arn:aws:iam::{aws-account-id}:role/dataplatform-{environment}-redshift-role'\n    CREATE EXTERNAL DATABASE IF NOT EXISTS;\n")),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE EXTERNAL SCHEMA housing_repairs_raw_zone\n    FROM DATA CATALOG\n    DATABASE 'housing-repairs-raw-zone'\n    IAM_ROLE 'arn:aws:iam::000000000000:role/dataplatform-prod-redshift-role'\n    CREATE EXTERNAL DATABASE IF NOT EXISTS;\n")),(0,o.kt)("h3",{id:"granting-a-user-access"},"Granting a User Access"),(0,o.kt)("p",null,"For a user to be able to access an external schema, they must first be granted the temp permission on the containing\ndatabase. Execute the following SQL against the Redshift Cluster:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT temp\n    ON DATABASE {database-name}\n    TO {username};\n")),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT temp\n    ON DATABASE data_platform\n    TO housing_repairs;\n")),(0,o.kt)("p",null,"Once a user has the temp permission of a specific database, they then need to be granted permissions on each External\nSchema that they need access to. Run the following commands for each Schema:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT USAGE\n    ON SCHEMA {schema-name}\n    TO {username};\n\nGRANT SELECT\n    ON ALL TABLES IN SCHEMA {schema-name}\n    TO {username};\n")),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT USAGE\n    ON SCHEMA housing_repairs_raw_zone\n    TO housing_repairs;\n\nGRANT SELECT\n    ON ALL TABLES IN SCHEMA housing_repairs_raw_zone\n    TO housing_repairs;\n")),(0,o.kt)("h2",{id:"role-based-access-control-rbac"},"Role based access control (RBAC)"),(0,o.kt)("h3",{id:"roles-management"},"Roles management"),(0,o.kt)("p",null,"Redshift roles are managed using Terraform configuration. Configuration can be used to create new roles, give roles access to external schemas and also to setup role grants to allow roles to inherit permissions from other roles."),(0,o.kt)("p",null,"Please see the ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/terraform/etl/42-redshift.tf"},"Terraform configuration")," for details."),(0,o.kt)("h3",{id:"users-permission-to-roles"},"Users permission to roles"),(0,o.kt)("p",null,"Redshift users can be granted access to roles by running the following command:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT ROLE {role-name} To {user-name};\n")),(0,o.kt)("p",null,"Example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"GRANT ROLE housing_ro to username;\n")),(0,o.kt)("p",null,"Please note if the username is an email address it must be wrapped in double quotes."),(0,o.kt)("h3",{id:"storing-the-credentials-of-the-created-user-in-a-parameters-store"},"Storing the credentials of the created user in a parameters store"),(0,o.kt)("p",null,"The password created for the user needs to be added to the record created by Terraform in the AWS Secret Manager."),(0,o.kt)("h3",{id:"how-do-we-know-if-it-worked"},"How do we know if it worked?"),(0,o.kt)("p",null,"You will know if it has worked because the data will be visible in the redshift and via the redshift connectors in tools such as Qlik or Google Data Studio using the credentials in AWS Secret Manager."),(0,o.kt)("h3",{id:"related-documents"},"Related documents"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"../playbook/querying-and-analysing-data/connecting-to-redshift-from-data-studio"},"Connecting to the Redshift cluster from Google Data Studio"))))}p.isMDXComponent=!0}}]);