"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[2904],{7103:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var a=t(4848),i=t(8453);const o={title:"Ingesting data from an API to the Data Platform",description:"Ingesting API data into the Data Platform using an AWS Lambda function",layout:"playbook_js",tags:["playbook"]},r=void 0,s={id:"playbook/ingesting-data/ingesting-api-data",title:"Ingesting data from an API to the Data Platform",description:"Ingesting API data into the Data Platform using an AWS Lambda function",source:"@site/docs/playbook/ingesting-data/009-ingesting-api-data.md",sourceDirName:"playbook/ingesting-data",slug:"/playbook/ingesting-data/ingesting-api-data",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/ingesting-api-data",draft:!1,unlisted:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/playbook/ingesting-data/009-ingesting-api-data.md",tags:[{inline:!0,label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",sidebarPosition:9,frontMatter:{title:"Ingesting data from an API to the Data Platform",description:"Ingesting API data into the Data Platform using an AWS Lambda function",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Ingesting new data entities via event streaming",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/event-streaming"},next:{title:"Production to pre-production data sync",permalink:"/Data-Platform-Playbook/playbook/ingesting-data/production-to-pre-production-sync"}},l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Overview",id:"overview",level:2},{value:"Contents",id:"contents",level:2},{value:"Add the API credentials to the Data Platform project",id:"add-the-api-credentials-to-the-data-platform-project",level:3},{value:"Add your script to the Data Platform repository",id:"add-your-script-to-the-data-platform-repository",level:3},{value:"Set up API Ingestion Lambda Module",id:"set-up-api-ingestion-lambda-module",level:3},{value:"The following input variables are required:",id:"the-following-input-variables-are-required",level:4},{value:"The following input variables are optional:",id:"the-following-input-variables-are-optional",level:4},{value:"Commit your changes and create a Pull Request for review by the Data Platform team",id:"commit-your-changes-and-create-a-pull-request-for-review-by-the-data-platform-team",level:3},{value:"Example Module Block",id:"example-module-block",level:3},{value:"Check that it works in Pre-Production",id:"check-that-it-works-in-pre-production",level:2},{value:"Setting up automated alerting for your Lambda",id:"setting-up-automated-alerting-for-your-lambda",level:3}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["You have a Python script to be used in the Lambda. If you want tips on how to write a Python script for this purpose, check out ",(0,a.jsx)(n.a,{href:"tips-on-how-to-write-an-API-Lambda-script",children:"this article"})]}),"\n",(0,a.jsxs)(n.li,{children:["You have a GitHub account, you can ",(0,a.jsx)(n.a,{href:"https://github.com/signup",children:"create one"})," yourself using your Hackney email."]}),"\n",(0,a.jsx)(n.li,{children:"You have been added to the 'LBHackney-IT' team, you can request this from Rashmi Shetty."}),"\n",(0,a.jsxs)(n.li,{children:["You need to have a department ready for the Data, by the time you reach the First Time Ingestion. You can find out how to onboard a department ",(0,a.jsx)(n.a,{href:"https://playbook.hackney.gov.uk/Data-Platform-Playbook/playbook/getting-set-up/onboarding-new-departments-to-the-platform",children:"Here"})]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,a.jsx)(n.p,{children:"This guide walks you through the process of setting up the infrastructure to deploy an AWS Lambda function to be used to ingest data from an API.\nIt assumes you already have a script that will make the API calls to retrieve the required data."}),"\n",(0,a.jsx)(n.h2,{id:"contents",children:"Contents"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Add the API credentials to the Data Platform project"}),"\n",(0,a.jsx)(n.li,{children:"Add your script to the Data Platform repository"}),"\n",(0,a.jsx)(n.li,{children:"Set up API Ingestion Lambda Module"}),"\n",(0,a.jsx)(n.li,{children:"Commit your changes and create a Pull Request for review by the Data Platform team"}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"add-the-api-credentials-to-the-data-platform-project",children:"Add the API credentials to the Data Platform project"}),"\n",(0,a.jsx)(n.p,{children:"The API credentials can be stored and retrieved from AWS Secrets Manager.\nYou will then be able to retrieve and use credentials in your Lambda function script."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Contact an engineer from the Data Platform team to add the API credentials to AWS Secrets Manager."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["You will need to request that a ",(0,a.jsx)(n.strong,{children:"secret"})," (with an appropriate description) is created following the naming convention below:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"/<department name>/<DATASET_NAME>\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Remember this name as you will need it later"}),". For example: ",(0,a.jsx)(n.code,{children:"/customer-services/casenotes-data-key"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"Request that the necessary API credentials be added to this secret in key-value pairs. For example:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"api_key"})," = ",(0,a.jsx)(n.code,{children:"RandomKey"})]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"secret"})," = ",(0,a.jsx)(n.code,{children:"RandomSecret"})]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["You will be notified once the secret has been stored with the credentials.\nMake a note of the ",(0,a.jsx)(n.strong,{children:"secret"})," name, and the ",(0,a.jsx)(n.strong,{children:"keys"})," set above as they will be needed in the ",(0,a.jsx)(n.a,{href:"#set-up-api-ingestion-lambda",children:"Set up API Ingestion Lambda"})," below."]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"add-your-script-to-the-data-platform-repository",children:"Add your script to the Data Platform repository"}),"\n",(0,a.jsx)(n.p,{children:"In this section, you'll be adding your script to the Data Platform repository so that it can be used in the Lambda function to ingest the API data."}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.strong,{children:"Note: You will need to complete this step from your IDE (Integrated Development Environment) or ask an engineer for assistance as it involves creating a directory which currently can't be done in the GitHub website user interface."})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["Open the ",(0,a.jsx)(n.a,{href:"https://github.com/LBHackney-IT/Data-Platform/tree/main/lambdas",children:"lambdas directory"})," in the Data Platform Project in GitHub."]}),"\n",(0,a.jsxs)(n.li,{children:["Create a new directory suffixed with ",(0,a.jsx)(n.code,{children:"_api_ingestion"}),".","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["Set this to the name of the data/API you are ingesting.\nEnsure the name is ",(0,a.jsx)(n.strong,{children:"lowercase"})," with ",(0,a.jsx)(n.strong,{children:"words separated by underscores"}),".\nFor example: ",(0,a.jsx)(n.code,{children:"casenotes_data_api_ingestion"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Make a note of the name of the directory as it will be needed for the ",(0,a.jsx)(n.a,{href:"#set-up-api-ingestion-lambda-module",children:"Set up API Ingestion Lambda Module"})," section below."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["Create a new file in this directory called ",(0,a.jsx)(n.code,{children:"main.py"}),", you can also add your tests to its own file: ",(0,a.jsx)(n.code,{children:"test.py"})]}),"\n",(0,a.jsxs)(n.li,{children:["Paste your code in the respective files. ",(0,a.jsxs)(n.strong,{children:["Ensure the main execution function in your ",(0,a.jsx)(n.code,{children:"main.py"})," file is called ",(0,a.jsx)(n.code,{children:"lambda_handler"}),"."]})]}),"\n",(0,a.jsx)(n.li,{children:"Seek assistance from an engineer to get the required packages for your Lambda installed."}),"\n",(0,a.jsxs)(n.li,{children:["Submit your changes by referring to the ",(0,a.jsx)(n.a,{href:"../getting-set-up/using-github#committing-your-changes-to-the-data-platform-project",children:"Committing changes"})," section of the ",(0,a.jsx)(n.strong,{children:"Using GitHub"})," guide.\nThe Data Platform team needs to approve any changes to the code, so your change won't happen automatically."]}),"\n"]}),"\n",(0,a.jsx)(n.admonition,{title:"Updating your Lambda script",type:"important",children:(0,a.jsx)(n.p,{children:"If you need to update your Lambda script in the future, you must follow steps 4-6 to have those changes deployed to the Data Platform Project."})}),"\n",(0,a.jsx)(n.h3,{id:"set-up-api-ingestion-lambda-module",children:"Set up API Ingestion Lambda Module"}),"\n",(0,a.jsx)(n.p,{children:"In this section, you will be writing the code, using a template format, that will deploy your Lambda function to the Data Platform Project (or update an existing one if you need to make changes to an existing Lambda function)."}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Note: The steps in this section refer specifically to GitHub user interface"}),". However, if you are familiar working with the Data Platform project from your IDE, then you can also make the changes in your IDE and commit them to the Data Platform repository."]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Open the ",(0,a.jsx)(n.a,{href:"https://github.com/LBHackney-IT/Data-Platform/tree/main/terraform/core",children:"terraform/core directory"})," in the Data Platform Project in GitHub."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["If you don't have the correct permissions, you'll get a '404' error (see the ",(0,a.jsx)(n.a,{href:"/Data-Platform-Playbook/playbook/getting-set-up/",children:"Getting Set Up documentation"}),")."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Open ",(0,a.jsx)(n.code,{children:"38-api-ingestion.tf"}),"."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Click ",(0,a.jsx)(n.code,{children:"edit"})," or the ",(0,a.jsx)(n.strong,{children:"pencil icon"})," (","\u270f\ufe0f",") then copy the last module block and paste it at the bottom of the file.\nAn example of what a module block looks like can be seen in the ",(0,a.jsx)(n.a,{href:"#example-module-block",children:"Example Module Block"})," section below."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["Update the ",(0,a.jsx)(n.code,{children:"module"})," name using the name convention ",(0,a.jsx)(n.code,{children:"<api_data_name>_api_ingestion"}),", for example: ",(0,a.jsx)(n.code,{children:'"casenotes_data_api_ingestion"'}),"."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The module name must be all ",(0,a.jsx)(n.strong,{children:"lowercase"})," with ",(0,a.jsx)(n.strong,{children:"words separated by underscores"}),".\nEnsure the name is unique to all other module names in this file."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"the-following-input-variables-are-required",children:"The following input variables are required:"}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsxs)(n.em,{children:[(0,a.jsx)(n.strong,{children:"Note"}),": If you have copied an existing module block then you won\u2019t need to change the ",(0,a.jsx)(n.strong,{children:"source"}),", ",(0,a.jsx)(n.strong,{children:"tags"}),", ",(0,a.jsx)(n.strong,{children:"identifier_prefix"}),", ",(0,a.jsx)(n.strong,{children:"lambda_artefact_storage_bucket"})," and, ",(0,a.jsx)(n.strong,{children:"secrets_manager_kms_key"})," input variables."]}),"\n",(0,a.jsx)(n.code,{children:"<ZONE>"})," refers to either: ",(0,a.jsx)(n.code,{children:"raw"}),", or ",(0,a.jsx)(n.code,{children:"landing"})," S3 zones."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"count"})," (required): ",(0,a.jsx)(n.code,{children:"count"})," determines where the Terraform will deploy the Lambda using Logic."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"local.is_live_environment"})," includes Production and Pre-Production"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"local.is_production_environment"})," includes Production"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"1:0"})," means for environments that satisfy the previous conditions, make ONE lambda, otherwise for other environments, make 0."]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.code,{children:"count = local.is_live_environment && !local.is_production_environment ? 1 : 0"})," then means ",(0,a.jsx)(n.code,{children:"if (Prod & Pre-prod) && (Not Prod), deploy 1, otherwise deploy 0"})," Meaning it will only deploy 1 into pre-prod"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"source"})," (required): This will be ",(0,a.jsx)(n.code,{children:'"../modules/api-ingestion-lambda"'}),". (This is the path to where the api ingestion Lambda module is saved within the repository)."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"tags"})," (required): This will be ",(0,a.jsx)(n.code,{children:"module.tags.values"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"identifier_prefix"})," (required): This will be ",(0,a.jsx)(n.code,{children:"local.short_identifier_prefix"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_artefact_storage_bucket"})," (required): This will be ",(0,a.jsx)(n.code,{children:"module.lambda_artefact_storage.bucket_id"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_name"})," (required): Name of the Lambda function. This should be the same as the name set in step 2 of the ",(0,a.jsx)(n.a,{href:"##add-you-script-to-the-data-platform-repository",children:"Add your script to the Data Platform repository"})," section above, ",(0,a.jsxs)(n.strong,{children:["however with words separated by hyphens (",(0,a.jsx)(n.code,{children:"-"}),") instead, and all lowercase."]}),"\n(This will be used to find your Lambda script)."]}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'lambda_name = "casenotes-data-api-ingestion"\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"secrets_manager_kms_key"})," (required): This will be ",(0,a.jsx)(n.code,{children:"aws_kms_key.secrets_manager_key"})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"s3_target_bucket_arn"})," (required): This will be ",(0,a.jsx)(n.code,{children:"module.<ZONE>_zone.bucket_arn"}),".\n",(0,a.jsx)(n.code,{children:"<ZONE>"})," should be either ",(0,a.jsx)(n.code,{children:"raw"}),", or ",(0,a.jsx)(n.code,{children:"landing"})," depending on the S3 zone you are ingesting your data to."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"s3_target_bucket_name"})," (required): The target S3 bucket to ingest the data to (this is used to set the Lambda permissions, you will also need to set this as an environment variable in the ",(0,a.jsx)(n.strong,{children:"lambda_environment_variables"})," input variable below)."]}),"\n",(0,a.jsxs)(n.p,{children:["This will be ",(0,a.jsx)(n.code,{children:"module.<ZONE>_zone.bucket_id"}),".\n",(0,a.jsx)(n.code,{children:"<ZONE>"})," should be either ",(0,a.jsx)(n.code,{children:"raw"}),", or ",(0,a.jsx)(n.code,{children:"landing"})," depending on the S3 zone you are ingesting your data to."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"api_credentials_secret_name"})," (required): This will be the same name you set in the previous section (this is used to set the Lambda permissions, you will also need to set this as an environment variable in the ",(0,a.jsx)(n.strong,{children:"lambda_environment_variables"})," input variable below)."]}),"\n",(0,a.jsx)(n.p,{children:"For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'api_credentials_secret_name = "api-credentials/case-notes"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["You will be able to retrieve these credentials in your code from the Environment Variables you will set below using the ",(0,a.jsx)(n.a,{href:"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/secretsmanager.html",children:"AWS SDK"})," for Secrets Manager."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"s3_target_bucket_kms_key_arn"})," (required): This will be ",(0,a.jsx)(n.code,{children:"module.<ZONE>_zone.kms_key_arn"}),".\n",(0,a.jsx)(n.code,{children:"<ZONE>"})," should be either ",(0,a.jsx)(n.code,{children:"raw"}),", or ",(0,a.jsx)(n.code,{children:"landing"})," depending on the S3 zone you are ingesting your data to."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_environment_variables"})," (required): An object containing key-value pairs of environment variables to be used in your Lambda code."]}),"\n",(0,a.jsxs)(n.p,{children:["For example: An API ingestion Lambda which has its API credentials stored as a secret called: ",(0,a.jsx)(n.code,{children:'"api-credentials/case-notes"'})," in AWS Secrets Manager, writes to a directory called: ",(0,a.jsx)(n.code,{children:"casenotes-data"})," in the Landing zone, and then triggers a Glue job to move it from the Landing zone to the Raw zone, will have the following set as environment variables:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'lambda_environment_variables = {\n  "SECRET_NAME" = "api-credentials/casenotes-data-key"\n  "TARGET_S3_BUCKET_NAME" = module.landing_zone.bucket_id\n  "OUTPUT_FOLDER" = "casenotes-data"\n  "GLUE_JOB_NAME" = module.copy_casenotes_data_landing_to_raw[0].job_name #Note: You would have to create this job\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsxs)(n.em,{children:["The ",(0,a.jsx)(n.code,{children:"OUTPUT_FOLDER"})," above can be your department name followed by dataset name if ingesting to your ",(0,a.jsx)(n.strong,{children:"department's raw zone"})," area. For example: ",(0,a.jsx)(n.code,{children:'"housing/casenotes-data"'}),"."]})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Environment variables set here can be retrieved in your Lambda code."}),"\nFor example, to retrieve the above environment variables, you would add the following to your Lambda code:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'from os import getenv\n\ndef lambda_handler(event, lambda_context):\n  load_dotenv()\n  secret_name = getenv("SECRET_NAME")\n  s3_bucket = getenv("TARGET_S3_BUCKET_NAME")\n  output_folder_name = getenv("OUTPUT_FOLDER")\n  glue_job_name = getenv("GLUE_JOB_NAME")\n'})}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.h4,{id:"the-following-input-variables-are-optional",children:"The following input variables are optional:"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.em,{children:"If an optional variable is not needed you should delete the entire line in the module block."})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"glue_job_to_trigger"})," (optional): The Glue job to trigger once the ingestion has completed (this is used to set the Lambda permissions, you will also need to set this as an environment variable in the ",(0,a.jsx)(n.strong,{children:"lambda_environment_variables"})," input variable above)."]}),"\n",(0,a.jsxs)(n.p,{children:["For instance, you may want to perform some transformations on the data or move it to another area once it has been ingested into the specified S3 location.\n",(0,a.jsxs)(n.strong,{children:["You will have to write some code in your Lambda to trigger this Glue job using the name.\nSee the ",(0,a.jsx)(n.a,{href:"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/glue.html#Glue.Client.start_job_run",children:"AWS Docs"})," for guidance on how to do this."]})]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"ephemeral_storage"})," (optional): The amount of Ephemeral storage (",(0,a.jsx)(n.code,{children:"/tmp"}),") to allocate for the Lambda Function in MBs.\nThis input variable can be used to expand the total amount of Ephemeral storage available beyond the ",(0,a.jsxs)(n.strong,{children:["default which is ",(0,a.jsx)(n.code,{children:"512"})," (MBs)."]})]}),"\n",(0,a.jsx)(n.p,{children:"In most cases the default value is sufficient, however, if your api ingestion Lambda runs an intensive/ heavy process, you may want to override this. For example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"ephemeral_storage = 6144\n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_timeout"})," (optional): The amount of time in seconds before the Lambda will time out/ stop running.\n",(0,a.jsxs)(n.strong,{children:["The default value is set to ",(0,a.jsx)(n.code,{children:"900"})," (seconds) which is 15 minutes"]}),". This is the ",(0,a.jsx)(n.strong,{children:"maximum"})," execution time for an AWS Lambda function."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_memory_size"})," (optional): The amount of memory in MBs your Lambda Function can use at runtime.\n",(0,a.jsxs)(n.strong,{children:["The default value is ",(0,a.jsx)(n.code,{children:"256"}),"."]}),"\nIn most cases the default value is sufficient, however, if your api ingestion Lambda runs an intensive/ heavy process, you may want to override this. For example:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"lambda_memory_size = 512 \n"})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"lambda_execution_cron_schedule"})," (optional): Schedule to run the Lambda function specified using Cron expressions (see ",(0,a.jsx)(n.a,{href:"https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/ScheduledEvents.html#CronExpressions",children:"AWS Cron Expression documentation"}),").\n",(0,a.jsx)(n.strong,{children:"The default schedule is 6am every day"}),"."]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsx)(n.p,{children:"For example, if you wanted your API ingestion Lambda run at 08:30am every day, your Cron expression would look like:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'lambda_execution_cron_schedule = "cron(30 8 * * ? *)"\n'})}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["You can also use ",(0,a.jsx)(n.a,{href:"https://www.freeformatter.com/cron-expression-generator-quartz.html",children:"this tool"})," to generate your Cron expressions."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"When you are done setting the input variables for this module, you can move onto the next section."}),"\n",(0,a.jsx)(n.h3,{id:"commit-your-changes-and-create-a-pull-request-for-review-by-the-data-platform-team",children:"Commit your changes and create a Pull Request for review by the Data Platform team"}),"\n",(0,a.jsx)(n.p,{children:"You can now submit your changes for review by the Data Platform team."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["See ",(0,a.jsx)(n.a,{href:"../getting-set-up/using-github#committing-your-changes-to-the-data-platform-project",children:"Committing changes"})," section of the ",(0,a.jsx)(n.strong,{children:"Using GitHub"})," guide.\nThe Data Platform team needs to approve any changes to the code that you make, so your change won't happen automatically.\nOnce your changes have been approved and deployed, the job will run at the next scheduled time (if scheduled)."]}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"example-module-block",children:"Example Module Block"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'module "something_api_ingestion" {\n  count                     = local.is_live_environment && !local.is_production_environment ? 1 : 0\n  source                    = "../modules/api-ingestion-lambda"\n  tags                      = module.tags.values\n  is_production_environment = local.is_production_environment\n  is_live_environment       = local.is_live_environment\n\n  identifier_prefix              = local.short_identifier_prefix\n  lambda_artefact_storage_bucket = module.lambda_artefact_storage.bucket_id\n  lambda_name                    = "something_api_ingestion"\n  lambda_handler                 = "main.lambda_handler"\n  runtime_language               = "python3.8"\n  secrets_manager_kms_key        = aws_kms_key.secrets_manager_key\n  s3_target_bucket_arn           = module.landing_zone.bucket_arn\n  s3_target_bucket_name          = local.s3_target_bucket_name\n  api_credentials_secret_name    = "something-secret-key"\n  s3_target_bucket_kms_key_arn   = module.landing_zone.kms_key_arn\n  lambda_memory_size \t\t\t = 1024 # You probably want this to be fairly large\n  lambda_environment_variables = {\n    "SECRET_NAME"           = "secret-name"\n    "TARGET_S3_BUCKET_NAME" = local.s3_target_bucket_name\n    "other environment variables, make a new line each" = "Value of these variables"\n  }\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Edit the values in the Terraform Module we just pasted to match your script."}),"\n",(0,a.jsx)(n.h2,{id:"check-that-it-works-in-pre-production",children:"Check that it works in Pre-Production"}),"\n",(0,a.jsx)(n.p,{children:"Once you have made changes to the Terraform and pushed the changes to GitHub, if there are no problems with your branch, the Lambda function will appear in Pre-Prod."}),"\n",(0,a.jsxs)(n.p,{children:["You can manually trigger the Lambda in the ",(0,a.jsx)(n.a,{href:"https://eu-west-2.console.aws.amazon.com/lambda/home?region=eu-west-2#/functions",children:"AWS Console"}),". If it runs with no issues, then it is ready to move into Prod. That is unlikely however, so here are some common issues"]}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:'If the Lambda reaches its max amount of memory, it will just break. You can increase the amount of memory by going to Configuration > General Configuration > Edit > Memory. And in Terraform the "lambda_memory_size" value will change the memory'}),"\n",(0,a.jsx)(n.li,{children:"If the Lambda reaches 15 minutes it will time out. If possible, change the Python script to just get less days of data."}),"\n",(0,a.jsx)(n.li,{children:"If it cannot find a package you are using in the Python Script, check your requirements.txt or Piplock files"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"Once it is in Production, it will automatically run every day. You now have data in the Landing Zone!"}),"\n",(0,a.jsx)(n.h3,{id:"setting-up-automated-alerting-for-your-lambda",children:"Setting up automated alerting for your Lambda"}),"\n",(0,a.jsx)(n.p,{children:"Lambda alerts module can be updated to include your Lambda function in the common alerts setup."}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Please note"})," the Lambda's log group must exist on production account for the module deployment to succeed. Log group will be created automatically as soon as the Lambda outputs something to the Cloudwatch logs for the first time."]}),"\n",(0,a.jsxs)(n.p,{children:["To setup automated alarms please add a new module to the ",(0,a.jsx)(n.a,{href:"https://github.com/LBHackney-IT/Data-Platform/blob/main/terraform/core/42-lambda-alarms-handler.tf",children:"41-lambda-failure-alarms.tf"})," file by copying one of the existing modules and updating the values as described below. Here's a sample module:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'module "ringgo_sftp_ingestion_lambda_alarm" {\n    count               = local.is_production_environment ? 1 : 0\n    source              = "../modules/lambda-alarms-and-monitoring"\n    tags                = module.tags.values\n    identifier_prefix   = local.short_identifier_prefix\n    lambda_name         = "${local.short_identifier_prefix}sftp-to-s3"\n    project             = var.project\n    environment         = var.environment\n    alarms_handler_lambda_name = module.lambda_alarms_handler[0].lambda_name\n    alarms_handler_lambda_arn = module.lambda_alarms_handler[0].lambda_arn\n}\n'})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'Please update the values inside <> as follows:\n\nmodule "<NAME_OF_THE_INGESTION>_ingestion_lambda_alarm" {\n    count               = local.is_production_environment ? 1 : 0\n    source              = "<PATH_TO_THE_LAMBDA_MODULE>"\n    tags                = module.tags.values\n    identifier_prefix   = local.short_identifier_prefix\n    lambda_name         = "${local.short_identifier_prefix}<NAME_OF_THE_DEPLOYED_LAMBDA>"\n    project             = var.project\n    environment         = var.environment\n    alarms_handler_lambda_name = module.lambda_alarms_handler[0].lambda_name\n    alarms_handler_lambda_arn = module.lambda_alarms_handler[0].lambda_arn\n}\n'})}),"\n",(0,a.jsx)(n.p,{children:"Once the alert module update has been deployed any errors thrown by the lambda function will trigger an alert to be sent to the central Google Space monitored by Data Platform team."})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>s});var a=t(6540);const i={},o=a.createContext(i);function r(e){const n=a.useContext(o);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),a.createElement(o.Provider,{value:n},e.children)}}}]);