"use strict";(self.webpackChunkdata_platform_playbook=self.webpackChunkdata_platform_playbook||[]).push([[9371],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>f});var o=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,o)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,o,r=function(e,t){if(null==e)return{};var a,o,r={},n=Object.keys(e);for(o=0;o<n.length;o++)a=n[o],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(o=0;o<n.length;o++)a=n[o],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=o.createContext({}),p=function(e){var t=o.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},d=function(e){var t=p(e.components);return o.createElement(l.Provider,{value:t},e.children)},c="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var a=e.components,r=e.mdxType,n=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),c=p(a),u=r,f=c["".concat(l,".").concat(u)]||c[u]||h[u]||n;return a?o.createElement(f,i(i({ref:t},d),{},{components:a})):o.createElement(f,i({ref:t},d))}));function f(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var n=a.length,i=new Array(n);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:r,i[1]=s;for(var p=2;p<n;p++)i[p]=a[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,a)}u.displayName="MDXCreateElement"},5297:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>n,metadata:()=>s,toc:()=>p});var o=a(7462),r=(a(7294),a(3905));const n={title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",layout:"playbook_js",tags:["playbook"]},i=void 0,s={unversionedId:"docs/liberator-ingestion",id:"docs/liberator-ingestion",title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",source:"@site/docs/docs/liberator-ingestion.md",sourceDirName:"docs",slug:"/docs/liberator-ingestion",permalink:"/Data-Platform-Playbook/docs/liberator-ingestion",draft:!1,editUrl:"https://github.com/LBHackney-IT/data-platform-playbook/edit/master/docs/docs/liberator-ingestion.md",tags:[{label:"playbook",permalink:"/Data-Platform-Playbook/tags/playbook"}],version:"current",frontMatter:{title:"Liberator data ingestion",description:"Description of the ingestion process for Liberator data",layout:"playbook_js",tags:["playbook"]},sidebar:"docs",previous:{title:"Import spreadsheets from G Drive",permalink:"/Data-Platform-Playbook/docs/import-spreadsheet-from-g-drive"},next:{title:"Redshift - Creating users, databases and exposing data from Glue",permalink:"/Data-Platform-Playbook/docs/redshift"}},l={},p=[{value:"1. SQL dump is uploaded into the platform",id:"1-sql-dump-is-uploaded-into-the-platform",level:4},{value:"2. RDS snapshot is created from the SQL dump",id:"2-rds-snapshot-is-created-from-the-sql-dump",level:4},{value:"3. Getting the data from the RDS snapshot into the landing zone as parquet files",id:"3-getting-the-data-from-the-rds-snapshot-into-the-landing-zone-as-parquet-files",level:4},{value:"Developer notes",id:"developer-notes",level:2}],d={toc:p},c="wrapper";function h(e){let{components:t,...n}=e;return(0,r.kt)(c,(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Liberator data ingestion process",src:a(8889).Z,width:"2484",height:"1234"})),(0,r.kt)("p",null,"This section describes how the Liberator dataset gets ingested into the data platform. "),(0,r.kt)("h4",{id:"1-sql-dump-is-uploaded-into-the-platform"},"1. SQL dump is uploaded into the platform"),(0,r.kt)("p",null,"The company who owns the dataset (Farthest Gate) uploads a zipped SQL dump of the whole database to S3 bucket in the data platform production AWS account at the path ",(0,r.kt)("inlineCode",{parentName:"p"},"s3://dataplatform-stg-liberator-data-storage/parking/"),".\nThe file needs to be named ",(0,r.kt)("inlineCode",{parentName:"p"},"liberator_dump_210604.zip")," where the date stamp at the end is the current date (format: YYMMDD)."),(0,r.kt)("h4",{id:"2-rds-snapshot-is-created-from-the-sql-dump"},"2. RDS snapshot is created from the SQL dump"),(0,r.kt)("p",null,"The upload of the S3 file triggers a cloudwatch event that in turn triggers the start of an ECS task (",(0,r.kt)("inlineCode",{parentName:"p"},"*liberator-to-rds-snapshot"),")."),(0,r.kt)("p",null,"The task does the following:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Deletes any RDS snapshots that already exist for ",(0,r.kt)("inlineCode",{parentName:"li"},"*liberator-to-rds-snapshot")," RDS instance"),(0,r.kt)("li",{parentName:"ul"},"Unzips the file"),(0,r.kt)("li",{parentName:"ul"},"Drops existing database"),(0,r.kt)("li",{parentName:"ul"},"Creates a new database from the SQL dump"),(0,r.kt)("li",{parentName:"ul"},"Starts off the process to create a database snapshot from this database")),(0,r.kt)("h4",{id:"3-getting-the-data-from-the-rds-snapshot-into-the-landing-zone-as-parquet-files"},"3. Getting the data from the RDS snapshot into the landing zone as parquet files"),(0,r.kt)("p",null,"A Cloudwatch Event Rule waits for the Snapshot to be created (RDS-EVENT-0042). This then invokes the lambda (",(0,r.kt)("inlineCode",{parentName:"p"},"*-export-rds-snapshot-to-s3"),") which finds the latest snapshot and starts an RDS export task that writes the snapshot to S3 (",(0,r.kt)("inlineCode",{parentName:"p"},"s3://*-dp-rds-export-storage/<snapshot_identifier>/*"),") in parquet format."),(0,r.kt)("p",null,"A Cloudwatch Event Rule waits for the Snapshot export to complete (RDS-EVENT-0161). When this event occurs it invokes the lambda  (",(0,r.kt)("inlineCode",{parentName:"p"},"*-rds-export-s3-to-s3-copier"),") that will copy all the files into the landing zone, with the standard date partitions added to the objects keys and any extra partitions added by the RDS export task are removed."),(0,r.kt)("p",null,"The lambda function will then start the glue parking liberator workflow (",(0,r.kt)("inlineCode",{parentName:"p"},"*parking-liberator-data-workflow"),"), which copies the data into the raw zone and runs a number of transformation jobs scheduled into the workflow."),(0,r.kt)("h2",{id:"developer-notes"},"Developer notes"),(0,r.kt)("p",null,"When deploying to development environment the Docker image for the ECS task is not deployed automatically. You can deploy it manually by running ",(0,r.kt)("inlineCode",{parentName:"p"},"make push-ecr")," from the project root."),(0,r.kt)("p",null,"To test the S3 file drop trigger and the entire process any zipped MySQL dump file can be used. These are readily available from various MySQL tutorials."))}h.isMDXComponent=!0},8889:(e,t,a)=>{a.d(t,{Z:()=>o});const o=a.p+"assets/images/liberator_ingestion-e9dcae6a4a558ad5ffc4bddfdca4b72b.png"}}]);